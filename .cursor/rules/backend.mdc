---
description: Tauri (Rust) バックエンドのコマンド、状態管理、セキュリティに関するルール
globs: src-tauri/**/*.rs
alwaysApply: false
---

## Tauri コマンド

- コマンドは `#[tauri::command]` 属性を使用して定義
- コマンド名は `snake_case` で命名
- 非同期処理が必要な場合は `async` を使用
- エラーは `Result<T, String>` または専用のエラー型で返す
- シリアライズ可能な型のみを引数・戻り値に使用（`serde::Serialize`, `serde::Deserialize`）

## 状態管理

- アプリケーション状態は `tauri::State<T>` で管理
- 状態の変更は `Mutex` や `RwLock` で保護
- グローバル状態は最小限に保つ

## フロントエンドとの連携

- `invoke` で呼び出すコマンド名はフロントエンドと一致させる
- データ構造は TypeScript の型定義と同期を保つ
- イベントは `tauri::Manager::emit` で送信

## ファイルシステム

- ファイル操作は `std::fs` または `tokio::fs` を使用
- パス操作は `std::path::PathBuf` を使用
- アプリケーションデータは `app.path()` (Manager's PathResolver) で取得したディレクトリに保存
  - 例: `app.path().app_data_dir()` でアプリ固有のディレクトリを取得
  - 例: `app.path().resolve(path, BaseDirectory::Resource)` でリソースを解決
- 古い `tauri::api::path` API は使用しない（Tauri v2では非推奨）

## エラーハンドリング

- `Result` 型を使用してエラーを伝播
- `unwrap()` や `expect()` は避け、`?` 演算子を使用
- カスタムエラー型は `thiserror` クレートで定義

## セキュリティ

- Tauri v2では capabilities-based permission system を使用（`allowlist` ではない）
- 権限は `src-tauri/capabilities/*.json` で定義
  - 例: `"core:default"`, `"sql:allow-execute"`, `"sql:allow-select"` など
- `tauri.conf.json` の `allowlist` は使用しない（Tauri v2では非推奨）
- ファイルアクセスはサンドボックス内に制限
- 外部 URL へのアクセスは CSP で制御
- シェルコマンドの実行は避ける（必要な場合は `sidecar` を使用）

## パフォーマンス

- 重い処理は非同期で実行
- 大量データの転送は避け、必要なデータのみを返す
- キャッシュを活用する
